---
# inner rule
# Fortigate

- set_fact:
    _src_names: []
    _dest_names: []
    _services: []
    _action: "{{ 'accept' if _rule.rule.action == 'permit' else 'deny' }}"

- set_fact:
    _intf: "{{ _rule.src.zone }}"

- name: loop src IP address list
  include_tasks:
    file: ipaddress_loop.yml
    apply:
      tags: rule
  loop: "{{ _rule.src.addresses }}"
  loop_control:
    label: "{{ _address.ipv4 }}"
    loop_var: _address
  when: _rule.src.addresses | length > 0
  tags: [rule]

- set_fact:
    _intf: "{{ _rule.dest.zone }}"
  
- name: loop dest IP address list
  include_tasks:
    file: ipaddress_loop.yml
    apply:
      tags: rule
  loop: "{{ _rule.dest.addresses }}"
  loop_control:
    label: "{{ _address.ipv4 }}"
    loop_var: _address
  when: _rule.src.addresses | length > 0
  tags: [rule]

- name: generate list of source addresses
  set_fact: 
    _src_names: "{{ _src_names + [{'name': item.name}] }}"
  loop: "{{ _rule.src.addresses }}"
  loop_control:
    label: "{{ item.name }}"

- name: generate list of destination addresses
  set_fact: 
    _dest_names: "{{ _dest_names + [{'name': item.name}] }}"
  loop: "{{ _rule.dest.addresses }}"
  loop_control:
    label: "{{ item.name }}"

- name: generate list of services
  set_fact: 
    _services: "{{ _services + [{'name': fg_services[item]}] }}"
  loop: "{{ _rule.services }}"

- debug: 
    var:  _services
    verbosity: 2

- name: "add rule {{ _rule.name }} to Fortigate"
  fortinet.fortios.fortios_firewall_policy:
    vdom: "{{ fw_fg_vdom | default('') }}"
    access_token: "{{ fw_access_token | default(omit) }}"
    state: present
    firewall_policy: 
      policyid: 4543
      name: "{{ _rule.name }}" 
      srcaddr: "{{ _src_names }}"
      srcintf:
        - name: "{{ _rule.src.zone }}"
      dstaddr: "{{ _dest_names }}"
      dstintf:
        - name: "{{ _rule.dest.zone }}"
      service: "{{ _services }}"
      action: "{{ _action }}" 
      schedule: always
